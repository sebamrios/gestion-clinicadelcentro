{% extends "base.html" %}
{% block content %}
<main class="container">
    <section class="py-5" style="background-color: #f8f9fa;">
        <div class="container">
            <div class="row align-items-center">
                <div class="container mt-4">
                <h2>Agenda de {{ agenda.profesional }}</h2>
                <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
</main>


<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        timeZone: 'UTC',
        initialView: 'timeGridWeek',
        themeSystem: 'bootstrap5',
        locale: 'es',
        allDaySlot: false,                         // primer renglon para eventos de todo el dia
        height: "auto",
        slotMinTime: "08:00:00",                   // horario de inicio
        slotMaxTime: "21:00:00",                   // horario de fin
        slotDuration: "0:30:00",
        slotLabelInterval: "00:30:00",             // mostrar etiqueta cada 30 min
        slotLabelFormat: {                         // formato de la etiqueta
            hour: "2-digit",
            minute: "2-digit",
            hour12: false                          // formato 24h
        },
        events: "{% url 'turnos_json' agenda.id %}",
        selectable: true,
        editable: true,

        // Click en un turno → editar
        eventClick: function(info) {
        window.location.href = "/turnos/turno/" + info.event.id + "/editar/";
        alert("Turno clickeado:\nID del turno: "+ info.event.id +"\nTítulo: " + info.event.title + "\nInicio: " + info.event.start.toISOString()+"\nFin: "+ info.event.end.toISOString())
        },

        // Selección de espacio libre → crear turno
        select: function(info) {
        alert("Nuevo turno desde " + info.startStr + " hasta " + info.endStr);
        // Podés abrir un modal o redirigir a un form de creación
        },

        // Click en un día → ir a ver_agenda.html
        dateClick: function(info) {
        const agendaId = "{{ agenda.id }}";       // variable de Django
        window.location.href = "/turnos/agendas/" + agendaId + "/";
        },

        eventDrop: function(info) {
        const csrfToken = "{{ csrf_token }}";
        const turnoId = info.event.id;
        const nuevaFecha = info.event.start.toISOString();

        // Construir los datos en formato URL encoded
        const params = new URLSearchParams();
        params.append("fecha_hora", nuevaFecha);

        fetch("/turnos/turno/" + turnoId + "/editar/", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrfToken,
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: params.toString()
            })
            .then(response => {
                if (!response.ok) {
                    alert(
                        "Error al actualizar turno:\nID: " + turnoId +
                        "\nTítulo: " + info.event.title +
                        "\nInicio: " + info.event.start.toISOString() +
                        "\nFin: " + info.event.end.toISOString()
                    );
                }
            })
            .catch(error => {
                console.error("Error en fetch:", error);
                alert("Error en la conexión al actualizar turno.");
            });
    }
    });
    calendar.render();
  });
</script>
{% endblock %}